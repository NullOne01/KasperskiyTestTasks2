using System.Collections.Generic;
using System.IO;
using System.Linq;
using scan_service.Data.MalwareTypes;

namespace scan_service.Scanner
{
    public class MalwareFileParser
    {
        private Dictionary<string, MalwareBadLine> _malwareTypes = new()
        {
            { "MALWARE_JS", new MalwareBadLine(@"^.*\.js$", @"<script>evil_script()</script>") },
            { "MALWARE_RM_RF", new MalwareBadLine(@"^.*$", @"rm -rf %userprofile%\Documents") },
            // ඞ
            { "MALWARE_SUS", new MalwareBadLine(@"^.*$", @"Rundll32 sus.dll SusEntry") }
        };

        public string ParseFile(FileInfo fileInfo)
        {
            // Get only types, where file name matches.
            var possibleMalware = _malwareTypes.Where(o => o.Value.DoFilePropertiesMatch(fileInfo))
                .ToDictionary(pair => pair.Key, pair => pair.Value);

            using var fileStream = File.OpenRead(fileInfo.FullName);
            using var streamReader = new StreamReader(fileStream);
            string line;
            while ((line = streamReader.ReadLine()) != null)
            {
                foreach (var (malwareName, malwareType) in possibleMalware)
                {
                    if (malwareType.DoLineMatch(line))
                    {
                        return malwareName;
                    }
                }
            }

            return string.Empty;
        }
    }
}